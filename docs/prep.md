# Подготовка кода
Для деплоя модели от разработчика требуется подготовить код с методами, которые будут разворачиваться в сервис, файл 
requirements.txt с указанием всех необходимых зависимостей и специальный файл с описанием модели - mmf.yml.

## Код
Необходимо подготовить функцию или несколько функций следующим образом (например файл main.py):
```python
# main.py
import pickle
from train import train, save # допустим наш код обучения модели находится в модуле train

with open('model', 'b') as f:
    model = pickle.load(f)

def score(data):
    """
    data: для json-задачи это будет dict, для разных видов задач могут быть разные виды данных, об этом подробнее в 
    описании каждого вида модели, но это всегда один аргумент.
    """
    return model(data)

def train(data):
    """
    Код обучения модели
    """
    model = train(data)
    save(model)
```
## requirements.txt
```text
pandas==1.2.0
sklearn==0.23.1
```
## mmf.yml
Для того, чтобы MMF понимал, что модель умеет делать и как ее разворачивать нужно ее описать с помощью файла mmf.yml. 
Для mmf модель сводится к набору функций, которые пробрасываются в api самого mmf. Эти функции могут выполнять разные
задачи, при этом mmf страется абстрагироваться от сути этих задач настолько насколько это возможно.
На текущий момент mmf выделяет следующие виды задач:

- `FileToFile`: задача, в которой пользователь отправляет файл для обработки и ожидает на выходе получить так же файл. 
Таким файлом может быть что угодно: картинка, документ excel, архив и тд.

Файлы могут доставляться двумя способами: через s3, либо напрямую.

Предполагается, что файлы могут иметь существенный размер, поэтому mmf перемещает их с использованием s3 - 
хранилища, те сначала файл попадает в хранилище, затем выгружается на диск в контейнере, в котором исполняется модель, 
затем результат исполнения с диска загружается в s3, после чего пользователь загружает результат себе напрямую из s3.
Такая схема может замедлять процесс доставки данных, накладывает дополнительный lattency, но гарантирует 
стабильную работу с большим объемом передаваемых данных. Весь процесс в интерфейсе для пользователя происходит незаметно, 
он видит только конечный результат.

В случае, если скорость доставки критична, небольшие файлы можно передавать напрямую от пользователя сразу в ram модели.
Важно понимать, что большие объемы таким образом передавать не получится, тк система обмена сообщениями не предназначена 
для этого. Максимально возможный размер сообщения в rabbitmq - 128мб, в kafka по-умолчанию вообще 1мб

- `JsonToJson`: задача, в которой пользователь отправляет json и на выходе ожидает так же json. Это практически то же 
самое, что FileToFile, но только файл тут одного конкретного типа - json. 
- `FileToArtifact`: задача, в которой пользователь направляет файл, а модель обновляет свои артефакты. Такой тип задач
применяется для автообучения модели. В результате обновления артефактов модель пересобирается в новый контейнер.

Пример заполнения mmf.yml:
```yaml
description: Демонстрация работы MMF
name: Тестовая mmf-совместимая модель
targets:
  - path: main.score
    name: Скоринг
    taskType: JsonToJson
    description: Описание функции score
  - path: main.train
    name: Автообучение
    taskType: FileToArtifact
    description: Описание алгоритма автообучения
    taskOptions:
      taskType: UpdateArtifacts
      artifacts:
        - model
artifacts:
  - name: Модель
    path: model
    description: Веса модели
```
[Подробная спецификация mmf.yml](mmfyml.md).

В будущем планируется упрощение работы с mmf.yml - в веб-интерфейсе импорта модели будет реализован диалог, с помощью 
которого mmf.yml можно будет сгенерировать автоматически.

Кроме того, уже сейчас доступна библиотека [mmf-meta](mmf-meta.md) для автоматизации заполнения этого файла:
